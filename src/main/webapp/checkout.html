<!--
Author: W3layouts
Author URL: http://w3layouts.com
License: Creative Commons Attribution 3.0 Unported
License URL: http://creativecommons.org/licenses/by/3.0/
-->
<!DOCTYPE HTML>
<html>
<head>
    <title>网上订餐系统的设计与实现</title>
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="css/style.css" rel="stylesheet" type="text/css" media="all"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="keywords" content="Spicemystery Responsive web template, Bootstrap Web Templates, Flat Web Templates, Andriod Compatible web template,
Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyErricsson, Motorola web design"/>
    <script type="application/x-javascript"> addEventListener("load", function () {
        setTimeout(hideURLbar, 0);
    }, false);

    function hideURLbar() {
        window.scrollTo(0, 1);
    } </script>
    <!--<link href='http://fonts.adminun/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='http://fonts.adminun/css?family=Libre+Baskerville:400,700' rel='stylesheet' type='text/css'>-->
    <script src="js/jquery.min.js"></script>
    <!--<link rel="stylesheet" href="css/flexslider.css" type="text/css" media="screen"/>-->
    <link rel="stylesheet" type="text/css" href="css/xcConfirm.css"/>
    <script src="js/jquery-1.9.1.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/xcConfirm.js" type="text/javascript" charset="utf-8"></script>
    <style type="text/css">
        .sgBtn{width: 135px; height: 35px; line-height: 35px; margin-left: 10px; margin-top: 10px; text-align: center; background-color: #0095D9; color: #FFFFFF; float: left; border-radius: 5px;}
    </style>
</head>
<body>
<!-- header -->
<div class="header-item"></div>
<script>
    $('.header-item').load('header.html');
</script>
<!-- header -->
<!--商家信息-->
<div class="shop-and-user-addr">
    <div class="left-title f_lf">
        <div class="big-p">
            <p class="delivery-addr-p f_rt">送货地址：</p><br>
        </div>
        <div class="clearfix"></div>
        <div class="small-p">
            <p class="other-font-size-18 f_rt">收货人：</p><br><div class="clearfix"></div>
            <p class="other-font-size-18 f_rt">预计送达时间：</p><br><div class="clearfix"></div>
            <p class="other-font-size-18 f_rt">配送费用：</p><br>
        </div>
    </div>
    <div class="right-value f_rt">
        <div class="mr_rt">
            <div class="big-p f_rt">
                <p id="delivery_addr" class="delivery-addr-p">未央区 陕西科技大学 9公寓</p><br>
            </div>
            <div class="clearfix"></div>
            <div class="small-p">
                <p id="user_name_and_phone" class="other-font-size-18 f_rt">刘女士（女士） 18702904814</p><br><div class="clearfix"></div>
                <p id="arrived_time" class="other-font-size-18 f_rt">立即送出-- 大约17：20 送达</p><br><div class="clearfix"></div>
                <p id="delivery_pay" class="other-font-size-18 f_rt">$ 9 元</p><br>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>
<div class="clearfix"></div>

<!-- checkout -->
<div class="cart-items">
    <div id="checked_items" class="container">
        <h1 id="shop_name"> 肯德基宅急送（科技大学店）</h1>
        <script>$(document).ready(function (c) {
            $('.close1').on('click', function (c) {
                $('.cart-header').fadeOut('slow', function (c) {
                    $('.cart-header').remove();
                });
            });
        });
        </script>
        <!--TODO:: 这里添加购物车的内容 -->
        <div class="cart-header">
            <div class="close1"></div>
            <div class="cart-sec simpleCart_shelfItem">
                <div class="cart-item cyc">
                    <img src="images/6p.jpg" class="img-responsive" alt="">
                </div>
                <div class="cart-item-info">
                    <h3><a href="#"> Lorem Ipsum is not simply </a><span>Pickup time:</span></h3>
                    <ul class="qty">
                        <li><p>Min. order value:</p></li>
                        <li><p>FREE delivery</p></li>
                    </ul>
                    <div class="delivery">
                        <p>Service Charges : $10.00</p>
                        <span>Delivered in 1-1:30 hours</span>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="clearfix"></div>

            </div>
        </div>
        <script>$(document).ready(function (c) {
            $('.close2').on('click', function (c) {
                $('.cart-header2').fadeOut('slow', function (c) {
                    $('.cart-header2').remove();
                });
            });
        });
        </script>
        <div class="cart-header2">
            <div class="close2"></div>
            <div class="cart-sec simpleCart_shelfItem">
                <div class="cart-item cyc">
                    <img src="images/8p.jpg" class="img-responsive" alt="">
                </div>
                <div class="cart-item-info">
                    <h3><a href="#"> Lorem Ipsum is not simply </a><span>Pickup time:</span></h3>
                    <ul class="qty">
                        <li><p>Min. order value:</p></li>
                        <li><p>FREE delivery</p></li>
                    </ul>
                    <div class="delivery">
                        <p>Service Charges : $10.00</p>
                        <span>Delivered in 1-1:30 hours</span>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="clearfix"></div>

            </div>
        </div>
        <script>$(document).ready(function (c) {
            $('.close3').on('click', function (c) {
                $('.cart-header3').fadeOut('slow', function (c) {
                    $('.cart-header3').remove();
                });
            });
        });
        </script>
        <div class="cart-header3">
            <div class="close3"></div>
            <div class="cart-sec simpleCart_shelfItem">
                <div class="cart-item cyc">
                    <img src="images/5p.jpg" class="img-responsive" alt="">
                </div>
                <div class="cart-item-info">
                    <h3><a href="#"> Lorem Ipsum is not simply </a><span>Pickup time:</span></h3>
                    <ul class="qty">
                        <li><p>Min. order value:</p></li>
                        <li><p>FREE delivery</p></li>
                    </ul>
                    <div class="delivery">
                        <p>Service Charges : $10.00</p>
                        <span>Delivered in 1-1:30 hours</span>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="clearfix"></div>

            </div>
        </div>
    </div>
    <div class="total-cart">
        <div>
            <span >总计金额</span>
        </div> <div class="clearfix"></div>
        <div>
            <p class="total-price" id="total_prices">$ 100 元</p>
        </div>
        <div class="clearfix"></div>
        <div>
            <a class="morebtn" href="#" onclick="submit_cart()">提交订单 </a>
        </div>
    </div>

    <!-- 遮罩层 -->
    <div id="cover" style="background: #000; position: absolute; left: 0px; top: 0px; width: 100%; filter: alpha(opacity=30); opacity: 0.3; display: none; z-index: 2 ">

    </div>
    <!-- 弹窗 -->
    <div id="showdiv" style="width: 80%; margin: 0 auto; height: 9.5rem; border: 1px solid #999; display: none; position: absolute; top: 40%; left: 10%; z-index: 3; background: #fff">
        <!-- 标题 -->
        <div style="background: #F8F7F7; width: 100%; height: 2rem; font-size: 0.65rem; line-height: 2rem; border: 1px solid #999; text-align: center;" >
            订单已成功提交
        </div>
        <!-- 内容 -->
        <div style="text-indent: 50px; height: 4rem; font-size: 0.5rem; padding: 0.5rem; line-height: 1rem; ">
            请保持手机13851435593畅通，稍后超人客服或餐厅会与您联系。

            感谢使用。

            </div>
        <!-- 按钮 -->
        <div style="background: #418BCA; width: 80%; margin: 0 auto; height: 1.5rem; line-height: 1.5rem; text-align: center;color: #fff;margin-top: 1rem; -moz-border-radius: .128rem; -webkit-border-radius: .128rem; border-radius: .128rem;font-size: .59733rem;" onclick="closeWindow()">
            <a id="order-detail" class="" href="order_success.html" onclick="">查看订单</a>
        </div>
</div>
<!-- checkout -->
<!-- footer-->
<div class="footer">
    <div class="container">
        <div class="footer-left">
            <p>Copyrights © 2015 SpiceMystery All rights reserved | Design by <a
                    href="http://w3layouts.com/">W3layouts</a></p>
        </div>
        <div class="footer-right">
            <ul>
                <li><a href="#"><i class="fbk"></i></a></li>
                <li><a href="#"><i class="googpl"></i></a></li>
                <li><a href="#"><i class="link"></i></a></li>
                <li><a href="#"><i class="rss"></i></a></li>
                <li><a href="#"><i class="twt"></i></a></li>
            </ul>
        </div>
        <div class="clearfix"></div>
        <input type="text" id="h_dispatch_pay" style="display: none"/>
    </div>
</div>
<!-- footer-->
<script>
    $(document).ready(function () {
        show_cart_total_price();

        $.getJSON("cart/cart-list.json",
            function (data) {

                var shop = data.shop;
                var checkList = "<h1 id=\"shop_name\">"+shop.shopName+"</h1>";
                var dispatchPay = shop.dispatchPay;
                var dispatchTime = shop.dispatchTime;
                var user = data.user;
                var totalPrice = 0.00;

                //TODO:: 需要将购物车面的东西完善
                $.each(data.items, function (i, item) {
                    //console.log(item);onclick='remove_item("+i+")'
                    var check_item = "<div class=\"cart-header"+i+"\">" +
                        " <div class=\"close"+i+"\" > </div>" +
                        " <div class=\"cart-sec simpleCart_shelfItem\">" +
                        "<div class=\"cart-item cyc\">" +
                        " <img src=" + item.picture + " class=\"img-responsive\" alt=\"\">" +
                        "</div>" +
                        "   <div class=\"cart-item-info\">" +
                        "<h3><a href=\"#\"> " + item.itemName + "</a><span>简介:" + item.itemTitle + "</span></h3>" +
                        "<ul class=\"qty\">" +
                        "<li><p>原价: $" + item.orginPrice + "</p></li>" +
                        "<li><p>月售: " + item.monthSale + "份</p></li>" +
                        "</ul>" +
                        " <div class=\"delivery\">" +
                        " <p>当前售价 : $" + item.price + "</p>" +
                        " <span>购买数量: " + item.payCount + "</span>" +
                        " <div class=\"clearfix\"></div>" +
                        "        </div>" +
                        "   </div>" +
                        "   <div class=\"clearfix\"></div>" +
                        "" +
                        "  </div>" +
                        " </div>";
                    totalPrice += item.price * item.payCount;
                    checkList += check_item;
                });
                $("#checked_items").html(checkList);

                //收件人
                $("#user_name_and_phone").html(user.userName +"   " +user.phone);
                //寄送地址
                $("#delivery_addr").html(user.address);
                //送货时间
                $("#arrived_time").html("立即送出 -- 约"+frontOneHour("hh:mm", dispatchTime * 60 * 1000) + "送达");
                console.log(dispatchPay);
                //配送费
                $("#delivery_pay").html("$:" +dispatchPay +"元");

                totalPrice += dispatchPay;
                console.log(parseFloat(totalPrice).toFixed(2));
                //总价
                $("#total_prices").html("$:"+ parseFloat(totalPrice).toFixed(2) +" 元");
                //设置快递费
                setTotalPrice(dispatchPay);
                //添加删除监听事件
                addRemoveItemFunc(data);
            });



    });

    //TODO：：隐藏成功框
    style="visibility: none;";

    document.getElementById("typediv1").style.visibility="hidden";//隐藏

    document.getElementById("typediv1").style.visibility="visible";//显示


    
    function submit_cart() {
       /*
        $('#showdiv').show();  //显示弹窗
        $('#cover').css('display','block'); //显示遮罩层
        $('#cover').css('height',document.body.clientHeight+'px'); //设置遮罩层的高度为当前页面高度
        $('#order-detail').href = "/order_success.html";
        */
        $.post("/submit/cart",
            function (data) {
                //订单成功
                if (data.status == 200) {
                    /*$('#showdiv').show();  //显示弹窗
                    $('#cover').css('display', 'block'); //显示遮罩层
                    $('#cover').css('height', document.body.clientHeight + 'px'); //设置遮罩层的高度为当前页面高度
                    $('#order-detail').href = "/order_success.html";*/
                    window.location.href = '/order_paid.html';
                } else if (data.status == 400) {
                    alert(data.msg);
                    return;
                }
            });
    }


    // 弹窗
    function showWindow() {
        $('#showdiv').show();  //显示弹窗
        $('#cover').css('display','block'); //显示遮罩层
        $('#cover').css('height',document.body.clientHeight+'px'); //设置遮罩层的高度为当前页面高度
    }
    // 关闭弹窗
    function closeWindow() {
        $('#showdiv').hide();  //隐藏弹窗
        $('#cover').css('display','none');   //显示遮罩层
    }


    function frontOneHour (fmt, moreTime) {
        var currentTime = new Date(new Date().getTime() + moreTime);
        console.log(currentTime) // Wed Jun 20 2018 16:12:12 GMT+0800 (中国标准时间)
        var o = {
            'M+': currentTime.getMonth() + 1, // 月份
            'd+': currentTime.getDate(), // 日
            'h+': currentTime.getHours(), // 小时
            'm+': currentTime.getMinutes(), // 分
            's+': currentTime.getSeconds(), // 秒
            'q+': Math.floor((currentTime.getMonth() + 3) / 3), // 季度
            'S': currentTime.getMilliseconds() // 毫秒
        }
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (currentTime.getFullYear() + '').substr(4 - RegExp.$1.length))
        for (var k in o) {
            if (new RegExp('(' + k + ')').test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)))
        }
        return fmt
    }

    //实时计算购物车的总价
    function show_cart_total_price() {

        $.getJSON("/cart/query-total.json",
            function (res) {
                if (res.status == 200 && res.data != null) {
                    var data = res.data;
                    console.log("cart--"+data.totalPrice);
                    var total = (parseFloat(data.totalPrice)).toFixed(2);
                    console.log("total--"+total);
                    $("#cart_total_price").text(total);
                    $("#total_count").text(data.itemCount);
                }
            }
        );
    }

    function remove_item(index) {

        var closex = ".close" + index;
        var cartheadern = ".cart-header"+index;
        console.log(closex +"  " + cartheadern);
        $(closex).on('click', function (c) {
            $(cartheadern).fadeOut('slow', function (c) {
                $(cartheadern).remove();
            });
        });
        var totalPrice = show_cart_total_price();
        var dispatchPay = getTotalPrice();
        $("#total_prices").html("$:"+ parseFloat(totalPrice + dispatchPay).toFixed(2) +" 元");
    }

    function addRemoveItemFunc(data) {
        $.each(data.items, function (i, item) {
            var closex = ".close" + i;
            var cartheadern = ".cart-header"+i;
            $(closex).on('click', function (c) {
                $(cartheadern).fadeOut('slow', function (c) {
                    $(cartheadern).remove();
                });
                $.post("/remove/from_cart",
                    {
                        id: item.id
                    },
                    function (data) {
                    data = data.data;
                        console.log(data);
                        //重新设置总价
                        show_cart_total_price();
                        var to;
                        if(data.itemCount != 0) {
                            to = parseFloat(parseFloat(data.totalPrice) + parseFloat(data.dispatchPay)).toFixed(2);
                        }else {
                            to = parseFloat(data.dispatchPay).toFixed(2);
                        }
                        $("#total_prices").html("$:"+ to +" 元");
                        console.log("total = " + to);
                    });
            });
        });
    }


    function setTotalPrice(dispatchPay) {

        $("#h_dispatch_pay").attr("value",dispatchPay);
    }
    function getTotalPrice() {

        return $("#h_dispatch_pay").val();
    }

</script>
</body>
</html>